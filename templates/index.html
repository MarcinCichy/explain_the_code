<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>RAG: Wyjaśnianie kodu Python</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- Styl do highlight.js, np. github-dark -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Lewy panel (konwersacje) -->
    <div class="sidebar">
        <h2>Twoje konwersacje</h2>
        <ul id="conversation-list">
            {% for cid in conversations %}
            <li class="conversation-item">
                <span class="conversation-name" onclick="loadConversation('{{ cid }}')">
                    Konwersacja {{ cid }}
                </span>
                <button class="delete-button" onclick="deleteConversation('{{ cid }}')">Usuń</button>
            </li>
            {% endfor %}
        </ul>
        <button id="new-conversation" class="green-button">Nowa konwersacja</button>
    </div>

    <!-- Środkowy panel (wklejanie kodu) -->
    <div class="middle-panel">
        <h1>Wklej kod Pythona do wyjaśnienia</h1>

        <!-- input hidden na aktualne conversation_id -->
        <input type="hidden" id="current-conversation-id" value="">

        <textarea id="code-snippet" rows="15"
                  placeholder="Tu wklej swój kod..."></textarea>

        <div class="buttons">
            <button id="explain-button" class="green-button">Wyjaśnij</button>
            <button id="reset-button" class="yellow-button">Resetuj rozmowę</button>
            <button id="exit-button" class="red-button">Zakończ</button>
        </div>
    </div>

    <!-- Prawy panel (wyjaśnienia) -->
    <div class="right-panel">
        <h1>Wyjaśnienia</h1>
        <div id="messages"></div>
    </div>
</div>

<script>
// Przechowuje aktualnie wybraną konwersację
let currentConversationId = "";

// Po załadowaniu
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("new-conversation").addEventListener("click", newConversation);
    document.getElementById("explain-button").addEventListener("click", explainCode);
    document.getElementById("reset-button").addEventListener("click", resetConversation);
    document.getElementById("exit-button").addEventListener("click", exitApp);
});

// ============================
//  Obsługa konwersacji
// ============================

async function newConversation() {
    const response = await fetch("/new_conversation", { method: "POST" });
    const data = await response.json();
    currentConversationId = data.conversation_id;
    document.getElementById("current-conversation-id").value = currentConversationId;

    // Wyzeruj prawy panel
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    // Odśwież listę
    renderConversations(data.conversations);
}

async function loadConversation(cid) {
    // wczytanie konwersacji
    const response = await fetch("/load_conversation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ conversation_id: cid })
    });
    const data = await response.json();

    // ustaw aktualne ID
    currentConversationId = data.conversation_id;
    document.getElementById("current-conversation-id").value = currentConversationId;

    // wyczyść prawy panel
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    // wstaw każdą wiadomość (code + explanation)
    data.messages.forEach(msg => {
        appendMessage(msg.code, msg.explanation);
    });
}

async function deleteConversation(cid) {
    const response = await fetch("/delete_conversation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ conversation_id: cid })
    });
    const data = await response.json();
    if (currentConversationId === data.conversation_id) {
        // jeśli usunięto konwersację, którą oglądaliśmy
        currentConversationId = "";
        document.getElementById("current-conversation-id").value = "";
        document.getElementById("messages").innerHTML = "";
    }
    renderConversations(data.conversations);
}

function renderConversations(conversationIds) {
    const ul = document.getElementById("conversation-list");
    ul.innerHTML = "";
    conversationIds.forEach(cid => {
        const li = document.createElement("li");
        li.classList.add("conversation-item");

        const span = document.createElement("span");
        span.classList.add("conversation-name");
        span.textContent = "Konwersacja " + cid;
        span.onclick = () => loadConversation(cid);

        const delBtn = document.createElement("button");
        delBtn.classList.add("delete-button");
        delBtn.textContent = "Usuń";
        delBtn.onclick = () => deleteConversation(cid);

        li.appendChild(span);
        li.appendChild(delBtn);
        ul.appendChild(li);
    });
}

// ============================
//  Obsługa wyjaśniania
// ============================

async function explainCode() {
    const code = document.getElementById("code-snippet").value;
    const conversationId = document.getElementById("current-conversation-id").value;

    // Wywołujemy /explain
    const response = await fetch("/explain", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ code, conversation_id: conversationId })
    });
    const data = await response.json();

    // Sprawdź, czy jest błąd
    if (data.error) {
        alert(data.error);
        return;
    }

    // Dodaj do panelu
    appendMessage(data.code, data.explanation);
    // Nie czyścimy code-snippet, aby użytkownik widział swój kod
}

function appendMessage(code, explanation) {
    const messagesDiv = document.getElementById("messages");

    // Blok "user" (kod)
    const userMessage = document.createElement("div");
    userMessage.className = "user-message";

    const preCode = document.createElement("pre");
    const codeEl = document.createElement("code");
    codeEl.className = "language-python";
    codeEl.textContent = code;
    preCode.appendChild(codeEl);

    userMessage.appendChild(preCode);
    messagesDiv.appendChild(userMessage);

    // Blok "bot" (wyjaśnienie) – parsujemy ewentualne ```python
    // Zastępujemy ```python ... ```
    const botMessage = document.createElement("div");
    botMessage.className = "bot-message";
    const processedExplanation = parseMarkdownToHtml(explanation);
    botMessage.innerHTML = processedExplanation;
    messagesDiv.appendChild(botMessage);

    // highlight.js
    document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Prosta funkcja do zmiany ```python na <pre><code class="language-python">
function parseMarkdownToHtml(text) {
    let result = text;
    result = result.replace(/```python/g, '<pre><code class="language-python">');
    result = result.replace(/```/g, '</code></pre>');
    // W code-blockach i tak mamy whitespace. Dla zwykłego tekstu -> <br>
    result = result.replace(/\n/g, '<br>');
    return result;
}

// ============================
//  Obsługa reset i exit
// ============================

async function resetConversation() {
    const conversationId = document.getElementById("current-conversation-id").value;
    if (!conversationId) {
        alert("Brak wybranej konwersacji do zresetowania.");
        return;
    }
    await fetch("/reset", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ conversation_id: conversationId })
    });

    document.getElementById("messages").innerHTML = "";
}

async function exitApp() {
    const response = await fetch("/exit", { method: "POST" });
    const data = await response.json();

    const messagesDiv = document.getElementById("messages");
    const exitMsg = document.createElement("div");
    exitMsg.className = "bot-message";
    exitMsg.innerHTML = `<strong>${data.message}</strong><br>
                         Liczba konwersacji: ${data.conversation_count}<br>
                         Liczba wyjaśnień: ${data.questions_asked}`;
    messagesDiv.appendChild(exitMsg);

    // Zablokuj dalsze interakcje
    document.getElementById("explain-button").remove();
    document.getElementById("reset-button").remove();
    document.getElementById("exit-button").remove();
    document.getElementById("new-conversation").remove();
}

// ============================
</script>
</body>
</html>
